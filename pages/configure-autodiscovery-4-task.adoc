= Configuring API Gateway API Autodiscovery in a Mule 4 Application

== Changes from Mule 3.x Configuration

API Autodiscovery element has syntactically changed from Mule 3.x, but its purpose remains the same. The element in a Mule Application has the following format:

[%header%autowidth.spread,cols="a,a"]
|===
^| Mule 3.x XML element ^| Mule 4.x XML element
^| <api-platform-gw:api (...)/>. ^| <api-gateway:autodiscovery (...)/>.
|===

In Mule 4, the API Autodiscovery element is identified by `apiId` and a reference to a Mule Flow where the HTTP listener is defined. Mule 4â€™s `apiId` replaces the `apiName` and `apiVersion` used to specify the Autodiscovery element in Mule 3.x and prior.

To configure API Autodiscovery in your Mule 4.x application, you must meet the following requirements:

* <<api-available, Make your API Available in API Manager>>
* Configure the following:
** <<configure-api-manager,API Manager>>
** <<anypoint-platform,Anypoint Platform Organization Credentials>> 
** <<autodiscovery-element,Autodiscovery Element>>

[[api-available]]
== Making your API Available in API Manager

The API to which you want to pair your Mule application must be available in API Manager. +
You can either:

* Publish your API in Exchange and xref:manage-exchange-api-task.adoc[import it from there to API Manager].
* xref:import-api-task.adoc[Import it directly from your machine].

API Manager generates an `apiId` identifier for every imported api. The Autodiscovery element uses this identifier to locate the API that you want to pair to your application:

image::api-id.png[align=center]


[[configure-api-manager]]
== Configuring API Manager

To instruct API Manager to use your deployed Mule application as the API proxy itself:
. A step here on how to navigate to UI.
. Click *Managing type*, and select *Basic Endpoint*.
. Add the *Implementation URI* that points to the deployed Mule application.
. Select the checkmark `Check this box if you are managing this API in Mule 4 or above`.

[[anypoint-platform]]
== Configuring Anypoint Platform Organization Credentials

To use Autodiscovery in a Mule Application, the Runtime must start with Anypoint Platform credentials already configured. +
Learn how to configure your organization credentials based on your deployment target in xref:org-credentials-config-mule4.adoc[Configuring Organization Credentials in Mule Runtime 4].

[[autodiscovery-element]]
== Configuring the Autodiscovery Element 

Within the code of your Mule Application, you must configure the `api-gateway:Autodiscovery` element. +
The Autodiscovery element points to the specific API in API Manager to which you want to pair.

[TIP]
If you've configured a proxy endpoint for your API, your autogenerated proxy will already be correctly configured with the Autodiscovery element.

An example of an XML element is shown below:

[source,xml,linenums]
----
<api-gateway:autodiscovery
  apiId="${apiId" // <1>
  flowRef= myFlow /> // <2>
----

<1> Configure the `apiId` with the API ID that API Manager assigned to your API.
<2> Set the `flowRef` element to point to the flow that you want to pair to the API in API Manager.

You can either replace `${apiId}` with your specific value, or you can create a `config.properties` file to define it as a key-value pair, for example `apiId=[your-specific-value]` and reference it as `${apiId}`.

You can also configure the Autodiscovery element using Anypoint Studio's UI:

. In your exist flow, select *Global Elements* in your Mule Configuration File editor.
. Click *Create*, and look for the API Autodiscovery global element.
+
image::auto-discovery-studio-7.png[align=center]
. Set the *API ID* and *Flow Reference*. +
+
image::auto-discovery-api-config.png[align=center]
+
You can also choose to use the `${apiId}` value and reference it from a `config.properties` file.

After you define the Autodiscovery element and configure the runtime with your Anypoint Platform credentials, Mule Runtime will automatically track and keep up to date with the API configuration defined in API Manager.
//_COMBAK: Does this need to be deployed for the green dot to show in API Manager?

== See Also

* xref:api-auto-discovery-new-concept.adoc[Reviewing API Gateway API Autodiscovery concepts
